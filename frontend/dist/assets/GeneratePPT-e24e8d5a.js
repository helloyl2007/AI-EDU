import{_ as Te,u as Ve,r as d,G as L,H as ue,b as h,d as a,e as u,f as p,g as l,w as c,n as P,i as F,E as j,k as ie,I as ee,F as A,j as M,l as J,t as $,m as q,J as Ce,h as te,K as le,L as je,M as $e,A as Ne,N as Se,O as Oe,P as Ee,Q as Le}from"./index-3f8b9c66.js";const Ae=[{value:"小学一年级",label:"小学一年级"},{value:"小学二年级",label:"小学二年级"},{value:"小学三年级",label:"小学三年级"},{value:"小学四年级",label:"小学四年级"},{value:"小学五年级",label:"小学五年级"},{value:"小学六年级",label:"小学六年级"},{value:"初中一年级",label:"初中一年级"},{value:"初中二年级",label:"初中二年级"},{value:"初中三年级",label:"初中三年级"}],Be={primary:[{value:"语文",label:"语文"},{value:"数学",label:"数学"},{value:"英语",label:"英语"}],junior:[{value:"语文",label:"语文"},{value:"数学",label:"数学"},{value:"英语",label:"英语"},{value:"物理",label:"物理"},{value:"化学",label:"化学"},{value:"生物",label:"生物"},{value:"历史",label:"历史"},{value:"地理",label:"地理"}]},ne={grades:Ae,subjects:Be};function De(k){const T=k.indexOf("{"),f=k.lastIndexOf("}");if(T===-1||f===-1)throw new Error("No valid JSON object found in the text");let N=k.substring(T,f+1);N=N.replace(/```json\s*|```\s*$/g,"");try{return JSON.parse(N),N}catch(S){throw new Error(`Invalid JSON format: ${S.message}`)}}function Je(k){return!k||typeof k!="object"||!k.topic||typeof k.topic!="string"||!Array.isArray(k.pages)?!1:k.pages.every(T=>!T.title||typeof T.title!="string"||!Array.isArray(T.pages)?!1:T.pages.every(f=>!(!f.sub_title||typeof f.sub_title!="string"||!Array.isArray(f.desc)||!Array.isArray(f.contents))))}const Me={class:"ppt-header"},Ke={class:"step-content"},Ue={key:0,class:"input-form"},Ge={class:"form-container"},ze={key:1,class:"outline-editor"},Fe={key:1,class:"stream-content"},qe=["innerHTML"],He={key:2,class:"action-buttons"},Re={key:3,class:"editor-layout"},Qe={class:"content-area"},We={class:"tree-node-content"},Xe={class:"node-header"},Ye={class:"page-label"},Ze={class:"node-title"},et={key:0,class:"node-content"},tt={class:"content-desc"},lt={key:0,class:"edit-mode"},nt=["onClick"],at={key:0,class:"content-detail"},st={key:0,class:"edit-mode"},ot=["onClick"],ut={key:1,class:"node-content"},it={key:0,class:"edit-mode"},rt=["onClick"],ct={key:4,class:"step-actions"},dt={key:2,class:"templates"},vt={class:"template-actions"},pt={class:"templates-container"},ft={class:"templates-grid"},_t={class:"template-card"},mt={class:"template-img-container"},gt=["src","alt"],yt={key:3},bt={__name:"GeneratePPT",setup(k){const T=Ve(),f=d(0);d(["cover"]);const N=d("page"),S=d(0),H=d(0),m=d({topic:"",pages:[]});d("");const ae=d([]),K=d(""),s=d({grade:"",subject:"",lesson:"",reviewPoints:"",commonMistakes:"",nextPoints:""}),re=d(ne.grades),ce=L(()=>s.value.grade?s.value.grade.includes("小学")?ne.subjects.primary:ne.subjects.junior:[]);function de(){s.value.subject=""}const R=()=>{const{grade:t,subject:e,lesson:i}=s.value;if(!t||!e||!i)throw new Error("请完整填写年级、学科和课时信息");return`${t}${e}${i}`},E=d(!1);d(!1),d(""),d(""),d(""),d(0),d("");const U=d(""),B=d("");d(null);const ve=L(()=>{if(!B.value)return"";let t="",e="",i=[],y=[];const _=()=>{e&&(t+=`<div class="content-title">${e}</div>`,e="");const g=Math.min(i.length,y.length);for(let n=0;n<g;n++)t+=`
        <div class="content-pair">
          <div class="content-desc">${i[n]}</div>
          <div class="content-text">${y[n]}</div>
        </div>`;i=[],y=[]},b=B.value.replace(/[\{\}\[\]"\\]/g,"").replace(/topic:|title:|pages:|sub_title:|desc:|contents:|,/g,"").replace(/\n\s+/g,`
`).split(`
`);for(const g of b){const n=g.trim();if(n){if(n.includes("小学")||n.includes("初中")){t+=`<div class="content-topic">${n}</div>`;continue}if(n.match(/^[一二三]、/)){_(),e=n;continue}if(n.includes("核心知识点")||n.includes("学习技巧")||n.includes("典型例子")||n.includes("普遍错误")||n.includes("错题解析")||n.includes("下一节准备")){_(),t+=`<div class="content-subtitle">${n}</div>`;continue}if(n.includes("知识点")||n.includes("技巧要点")||n.includes("例子场景")||n.includes("错误类型")||n.includes("解析要点")||n.includes("学习目标")||n.includes("预习重点")){i.push(n);continue}if(n&&!n.includes('"')&&!n.includes(":")){y.push(n);continue}}}return _(),t});ue(()=>f.value,()=>{ee(()=>{window.scrollTo(0,0)})},{immediate:!0});const se=L(()=>B.value.length>0);async function oe(){try{if(!s.value.grade||!s.value.subject||!s.value.lesson||!s.value.reviewPoints||!s.value.commonMistakes||!s.value.nextPoints){j.warning("请填写所有必要信息");return}E.value=!0,O.value=!1,B.value="",U.value="",f.value=1,Z(),m.value={topic:R(),pages:[]};const t=R(),i=(await fetch("http://edu.xiaojuai.com:8100/api/ppt/outline",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({topic:t,reviewPoints:s.value.reviewPoints,commonMistakes:s.value.commonMistakes,nextPoints:s.value.nextPoints,grade:s.value.grade,subject:s.value.subject})})).body.getReader(),y=new TextDecoder;for(;;){const{done:_,value:b}=await i.read();if(_)break;const n=y.decode(b).split(`
`);for(const x of n)if(!(!x.trim()||x.trim()==="data: [DONE]"))try{const w=x.replace(/^data: /,""),G=JSON.parse(w);if(G.choices?.[0]?.delta?.content){const z=G.choices[0].delta.content;B.value+=z,U.value+=z}}catch(w){console.warn("解析流数据失败:",w)}}try{const _=De(U.value),b=JSON.parse(_);if(!Je(b))throw new Error("PPT内容结构不符合要求");m.value=b,j.success("提纲生成成功")}catch(_){console.error("内容解析或验证失败:",_),j.error("内容解析失败："+_.message),m.value={topic:R(),pages:[]}}}catch(t){console.error("生成失败:",t),j.error("生成提纲失败")}finally{E.value=!1}}async function pe(){if(!m.value.topic||!m.value.pages.length){j.warning("课件内容不能为空");return}try{const t=await ie.post("http://edu.xiaojuai.com:8100/api/ppt/templates");ae.value=t.data.templates,f.value=2,Z()}catch{j.error("获取模板失败")}}const Q=d(!1);function fe(){if(!K.value){j.warning("请选择模板");return}Q.value=!0;const e={topic:m.value.topic,content:JSON.stringify(m.value),template_id:K.value};ie.post("http://edu.xiaojuai.com:8100/api/ppt/generate",e).then(async i=>{localStorage.setItem("lastGeneratedPPT",JSON.stringify({file_id:i.data.file_id,time:Date.now()})),console.log("PPT生成请求已发送，ID:",i.data.file_id),f.value=3,await ee(),window.scrollTo(0,0),j.success("PPT生成任务已开始")}).catch(i=>{console.error("PPT生成请求失败",i),j.error(i.response?.data?.detail||"生成PPT失败")}).finally(()=>{Q.value=!1})}function _e(){T.push("/aiedu/generate-ppt")}const me=L(()=>{const t=[];t.push({label:"课件封面",type:"cover",orderLabel:"第1页：",icon:"Document",content:m.value?.topic||"请填写课件主题"}),t.push({label:"目录",type:"page",orderLabel:"第2页：",icon:"Menu",content:"课件目录页（自动生成）"});let e=3;return m.value.pages.forEach((i,y)=>{const _={label:i.title,type:"page",pageIndex:y,orderLabel:`第${e}页：`,icon:"Reading",children:[]};e++,i.pages.forEach((b,g)=>{_.children.push({label:b.sub_title,type:"subPage",pageIndex:y,subPageIndex:g,orderLabel:`第${e}页：`,icon:"Document",desc:b.desc,contents:b.contents}),e++}),t.push(_)}),t}),ge=t=>{N.value=t.type,t.type==="page"?S.value=t.pageIndex:t.type==="subPage"&&(S.value=t.pageIndex,H.value=t.subPageIndex)};L(()=>{if(N.value==="page"&&m.value.pages[S.value])return{title:m.value.pages[S.value].title,type:"page"};if(N.value==="subPage"&&m.value.pages[S.value]?.pages[H.value]){const t=m.value.pages[S.value].pages[H.value];return{title:t.sub_title,desc:t.desc,contents:t.contents,type:"subPage"}}return null});const v=d({pageIndex:null,subPageIndex:null,contentIndex:null,value:"",type:""}),W={mounted:t=>t.querySelector("textarea").focus()},X=(t,e,i,y="content")=>{v.value={pageIndex:t.pageIndex,subPageIndex:t.subPageIndex,contentIndex:e,value:i,type:y}},D=t=>{if(v.value.type==="topic")m.value.topic=v.value.value;else if(t.pageIndex!==void 0&&t.subPageIndex!==void 0){const e=m.value.pages[t.pageIndex];if(e&&e.pages[t.subPageIndex]){const i=e.pages[t.subPageIndex];v.value.type==="desc"?i.desc[v.value.contentIndex]=v.value.value:i.contents[v.value.contentIndex]=v.value.value}}v.value={pageIndex:null,subPageIndex:null,contentIndex:null,value:"",type:""}},O=d(!1);L(()=>`editing-${O.value?"true":"false"}`);const ye=async()=>{O.value=!1,B.value="",U.value="",await oe()},be=()=>{O.value=!0,setTimeout(()=>{window.scrollTo(0,0),document.documentElement.scrollTop=0,document.body.scrollTop=0;const t=document.querySelector(".ppt-header");t&&t.scrollIntoView({behavior:"auto",block:"start"}),console.log("已尝试滚动到页面顶部")},150)},he=L(()=>`step-${f.value}`),Y=d(null),Z=()=>{ee(()=>{setTimeout(()=>{Y.value&&(Y.value.scrollIntoView({behavior:"instant",block:"start"}),window.scrollTo({top:0,behavior:"instant"}))},100)})};ue(()=>f.value,(t,e)=>{t!==e&&Z()},{immediate:!0});const ke=["正在分析课程结构...","正在提取教学重点...","正在设计PPT框架...","正在优化课件内容..."],xe=["课程目标","知识框架","教学重点","学习难点","课件结构","内容优化"];return(t,e)=>{const i=h("el-step"),y=h("el-steps"),_=h("el-option"),b=h("el-select"),g=h("el-form-item"),n=h("el-input"),x=h("el-icon"),w=h("el-button"),G=h("el-form"),z=h("el-tree"),Pe=h("el-radio"),we=h("el-radio-group"),Ie=h("el-result");return a(),u("div",{class:"generate-ppt",ref_key:"pageContainer",ref:Y},[p("div",Me,[l(y,{active:f.value,"finish-status":"success"},{default:c(()=>[l(i,{title:"输入信息"}),l(i,{title:"编辑课件内容"}),l(i,{title:"选择模板"}),l(i,{title:"生成课件"})]),_:1},8,["active"])]),(a(),u("div",{class:"ppt-content",key:he.value},[p("div",Ke,[f.value===0?(a(),u("div",Ue,[p("div",Ge,[l(G,{model:s.value,"label-width":"120px"},{default:c(()=>[l(g,{label:"年级"},{default:c(()=>[l(b,{modelValue:s.value.grade,"onUpdate:modelValue":e[0]||(e[0]=o=>s.value.grade=o),placeholder:"请选择年级",onChange:de},{default:c(()=>[(a(!0),u(A,null,M(re.value,o=>(a(),F(_,{key:o.value,label:o.label,value:o.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(g,{label:"学科"},{default:c(()=>[l(b,{modelValue:s.value.subject,"onUpdate:modelValue":e[1]||(e[1]=o=>s.value.subject=o),placeholder:"请选择学科",disabled:!s.value.grade},{default:c(()=>[(a(!0),u(A,null,M(ce.value,o=>(a(),F(_,{key:o.value,label:o.label,value:o.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),l(g,{label:"课时"},{default:c(()=>[l(n,{modelValue:s.value.lesson,"onUpdate:modelValue":e[2]||(e[2]=o=>s.value.lesson=o),placeholder:"请输入课时名称"},null,8,["modelValue"])]),_:1}),l(g,{label:"复习要点"},{default:c(()=>[l(n,{modelValue:s.value.reviewPoints,"onUpdate:modelValue":e[3]||(e[3]=o=>s.value.reviewPoints=o),type:"textarea",rows:4,placeholder:"请输入本节课需要复习的主要知识点"},null,8,["modelValue"])]),_:1}),l(g,{label:"普遍错题"},{default:c(()=>[l(n,{modelValue:s.value.commonMistakes,"onUpdate:modelValue":e[4]||(e[4]=o=>s.value.commonMistakes=o),type:"textarea",rows:4,placeholder:"根据作业情况，分析学生普遍没掌握的知识"},null,8,["modelValue"])]),_:1}),l(g,{label:"下一节要点"},{default:c(()=>[l(n,{modelValue:s.value.nextPoints,"onUpdate:modelValue":e[5]||(e[5]=o=>s.value.nextPoints=o),type:"textarea",rows:4,placeholder:"请输入下一节课的主要内容"},null,8,["modelValue"])]),_:1}),l(g,{class:"form-actions"},{default:c(()=>[l(w,{type:"primary",size:"large",onClick:oe,loading:E.value},{default:c(()=>[l(x,null,{default:c(()=>[l(J(je))]),_:1}),p("span",null,$(E.value?"正在生成内容...":"生成课件内容"),1)]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])])])):P("",!0),f.value===1?(a(),u("div",ze,[E.value&&!se.value?(a(),F($e,{key:0,stages:ke,keywords:xe,"position-class":"position-center",show:!0})):P("",!0),se.value&&!O.value?(a(),u("div",Fe,[p("div",{class:"formatted-content",innerHTML:ve.value},null,8,qe)])):P("",!0),!E.value&&!O.value?(a(),u("div",He,[l(w,{type:"",onClick:ye},{default:c(()=>[l(x,null,{default:c(()=>[l(J(Ne))]),_:1}),e[10]||(e[10]=q(" 重新生成提纲 ",-1))]),_:1}),l(w,{type:"primary",onClick:be},{default:c(()=>[l(x,null,{default:c(()=>[l(J(Se))]),_:1}),e[11]||(e[11]=q(" 编辑课件内容 ",-1))]),_:1})])):P("",!0),!E.value&&O.value?(a(),u("div",Re,[p("div",Qe,[l(z,{data:me.value,props:t.defaultProps,"highlight-current":"",onNodeClick:ge,"default-expand-all":!0},{default:c(({node:o,data:r})=>[p("div",We,[p("div",Xe,[l(x,null,{default:c(()=>[(a(),F(Ce(r.icon)))]),_:2},1024),p("span",Ye,$(r.orderLabel),1),p("span",Ze,$(o.label),1)]),r.desc&&r.contents?(a(),u("div",et,[(a(!0),u(A,null,M(r.desc,(V,I)=>(a(),u("div",{key:I,class:"content-pair"},[p("div",tt,[v.value.pageIndex===r.pageIndex&&v.value.subPageIndex===r.subPageIndex&&v.value.contentIndex===I&&v.value.type==="desc"?(a(),u("div",lt,[te(l(n,{modelValue:v.value.value,"onUpdate:modelValue":e[6]||(e[6]=C=>v.value.value=C),type:"textarea",rows:2,onBlur:C=>D(r),onKeyup:le(C=>D(r),["enter"])},null,8,["modelValue","onBlur","onKeyup"]),[[W]])])):(a(),u("div",{key:1,class:"desc-text",onClick:C=>X(r,I,V,"desc")},$(V),9,nt))]),r.contents[I]?(a(),u("div",at,[v.value.pageIndex===r.pageIndex&&v.value.subPageIndex===r.subPageIndex&&v.value.contentIndex===I&&v.value.type==="content"?(a(),u("div",st,[te(l(n,{modelValue:v.value.value,"onUpdate:modelValue":e[7]||(e[7]=C=>v.value.value=C),type:"textarea",rows:2,onBlur:C=>D(r),onKeyup:le(C=>D(r),["enter"])},null,8,["modelValue","onBlur","onKeyup"]),[[W]])])):(a(),u("div",{key:1,class:"content-text",onClick:C=>X(r,I,r.contents[I],"content")},$(r.contents[I]),9,ot))])):P("",!0)]))),128))])):r.content?(a(),u("div",ut,[r.type==="cover"?(a(),u(A,{key:0},[v.value.type==="topic"?(a(),u("div",it,[te(l(n,{modelValue:v.value.value,"onUpdate:modelValue":e[8]||(e[8]=V=>v.value.value=V),type:"textarea",rows:2,onBlur:V=>D(r),onKeyup:le(V=>D(r),["enter"])},null,8,["modelValue","onBlur","onKeyup"]),[[W]])])):(a(),u("div",{key:1,class:"content-text",onClick:V=>X(r,null,r.content,"topic")}," 课件主题："+$(r.content),9,rt))],64)):Array.isArray(r.content)?(a(!0),u(A,{key:1},M(r.content,(V,I)=>(a(),u("div",{key:I,class:"content-item"},$(V),1))),128)):(a(),u(A,{key:2},[q($(r.content),1)],64))])):P("",!0)])]),_:1},8,["data","props"])])])):P("",!0),O.value?(a(),u("div",ct,[l(w,{type:"primary",size:"large",onClick:pe},{default:c(()=>[l(x,null,{default:c(()=>[l(J(Oe))]),_:1}),e[12]||(e[12]=q(" 选择模板 ",-1))]),_:1})])):P("",!0)])):P("",!0),f.value===2?(a(),u("div",dt,[p("div",vt,[l(w,{type:"primary",size:"large",onClick:fe,disabled:Q.value},{default:c(()=>[l(x,null,{default:c(()=>[l(J(Ee))]),_:1}),e[13]||(e[13]=p("span",null,"生成复习课件",-1))]),_:1},8,["disabled"])]),p("div",pt,[l(we,{modelValue:K.value,"onUpdate:modelValue":e[9]||(e[9]=o=>K.value=o)},{default:c(()=>[p("div",ft,[(a(!0),u(A,null,M(ae.value,o=>(a(),u("div",{key:o.id,class:"template-item"},[l(Pe,{label:o.id},{default:c(()=>[p("div",_t,[p("div",mt,[p("img",{src:o.preview,alt:o.name},null,8,gt)]),p("span",null,$(o.name),1)])]),_:2},1032,["label"])]))),128))])]),_:1},8,["modelValue"])])])):P("",!0),f.value===3?(a(),u("div",yt,[l(Ie,{icon:"success",title:"PPT生成任务已开始","sub-title":"系统正在为您生成PPT，您可以返回列表页查看进度"},{extra:c(()=>[l(w,{type:"primary",size:"large",onClick:_e},{default:c(()=>[l(x,null,{default:c(()=>[l(J(Le))]),_:1}),e[14]||(e[14]=p("span",null,"返回列表",-1))]),_:1})]),_:1})])):P("",!0)])]))],512)}}},kt=Te(bt,[["__scopeId","data-v-980df81e"]]);export{kt as default};
//# sourceMappingURL=GeneratePPT-e24e8d5a.js.map
