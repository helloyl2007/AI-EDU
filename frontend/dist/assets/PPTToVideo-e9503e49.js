import{_ as oe,R as ne,u as ae,r as y,G as le,o as ie,a as re,k as V,E as w,b as d,d as m,e as v,f as i,g as n,w as a,n as g,i as D,l as k,m as h,F as ce,j as de,t as $,v as ue,S as me,z as pe,T as _e,s as fe}from"./index-3f8b9c66.js";const ve={class:"ppt-video-list"},ge={class:"header"},he={key:0,class:"video-grid"},ye={class:"video-card-content"},we=["onClick"],$e=["src"],be={class:"video-duration"},ke={key:0,class:"video-status-overlay"},Te={key:0,class:"status-progress"},Ue={key:1,class:"play-button"},xe={class:"video-info"},Ve=["title"],Se={class:"video-meta"},Ce={class:"create-time"},De={class:"file-size"},Ee={key:0,class:"video-owner"},Pe={class:"video-actions"},Le={class:"main-actions"},Be={class:"more-actions"},Re={key:0,class:"video-container"},ze=["src"],Me={key:1,class:"loading-container"},Ne={__name:"PPTToVideo",setup(je){const E=ne(),P=ae(),u="http://edu.xiaojuai.com:8100",b=y(!1),r=y([]),S=y(!1),T=y(null),U=y(null),L=`${u}/static/images/default-video-thumbnail.jpg`,z=le(()=>E.roles&&E.roles.includes("admin")),_=y(new Map);ie(async()=>{await M(),B()}),re(()=>{_.value.forEach(e=>clearTimeout(e))});function B(){_.value.forEach(t=>clearTimeout(t)),_.value.clear();const e=r.value.filter(t=>t.status==="processing");e.forEach(t=>{const o=setTimeout(()=>{C(t.id)},3e3);_.value.set(t.id,o)}),console.log(`正在跟踪 ${e.length} 个处理中的视频`)}async function C(e){try{const o=(await V.get(`${u}/api/video/${e}`)).data,l=r.value.findIndex(f=>f.id===e);if(l!==-1){const f=r.value[l].status,c=o.status;if(r.value[l]={...r.value[l],...o,thumbnailUrl:c==="completed"?`${u}${o.thumbnailUrl||o.videoUrl}#t=0.1&_=${new Date().getTime()}`:r.value[l].thumbnailUrl||L},console.log(`视频 ${e} 状态: ${f} -> ${c}`),f==="processing"&&c==="completed"&&setTimeout(async()=>{try{const p=await V.get(`${u}/api/video/${e}`);p.data.thumbnailUrl?r.value[l].thumbnailUrl=`${u}${p.data.thumbnailUrl}?_=${new Date().getTime()}`:p.data.videoUrl&&(r.value[l].thumbnailUrl=`${u}${p.data.videoUrl}#t=0.1&_=${new Date().getTime()}`)}catch(p){console.error("刷新缩略图失败:",p)}},100),c==="processing"){const p=setTimeout(()=>{C(e)},3e3);_.value.set(e,p)}else _.value.delete(e),c==="completed"?w({message:"视频已生成完成!",type:"success"}):c==="failed"&&w({message:"视频生成失败",type:"error"})}}catch(t){console.error(`检查视频 ${e} 状态失败:`,t);const o=_.value.get(e)||0;if(typeof o=="number"&&o<5){const l=setTimeout(()=>{C(e)},5e3);_.value.set(e,l)}else _.value.delete(e)}}async function M(){b.value=!0;try{const e=await V.get(`${u}/api/video/list`);r.value=e.data.map(t=>({...t,thumbnailUrl:t.thumbnailUrl?`${u}${t.thumbnailUrl}?_=${new Date().getTime()}`:t.videoUrl?`${u}${t.videoUrl}#t=0.1&_=${new Date().getTime()}`:null})),B()}catch(e){console.error("获取视频列表失败:",e),w.error("获取视频列表失败")}finally{b.value=!1}}function N(){P.push("/aiedu/ppt-to-video/create")}function R(e){T.value=e,e.videoUrl&&(T.value={...e,videoUrl:`${e.videoUrl}?t=${new Date().getTime()}`}),S.value=!0}function j(){U.value&&(U.value.pause(),U.value.currentTime=0)}function F(e){if(e&&e.videoUrl){const t=`${e.filename||"视频"}.mp4`,o=new XMLHttpRequest;o.open("GET",`${u}${e.videoUrl}`,!0),o.responseType="blob",o.onload=function(){if(this.status===200){const l=new Blob([this.response],{type:"video/mp4"}),f=window.URL.createObjectURL(l),c=document.createElement("a");c.href=f,c.download=t,c.click(),setTimeout(()=>{window.URL.revokeObjectURL(f)},100)}},o.send()}else w.error("视频链接无效")}async function A(e){try{await fe.confirm("确定要删除这个视频及其所有相关资源吗？此操作不可恢复！","删除确认",{type:"warning",confirmButtonText:"确认删除",cancelButtonText:"取消"});const t=await V.delete(`${u}/api/video/${e.id}`);if(t.data&&t.data.status==="success")w({type:"success",message:t.data.message||"视频已成功删除"}),r.value=r.value.filter(o=>o.id!==e.id);else throw new Error(t.data?.message||"删除失败")}catch(t){if(t==="cancel")return;console.error("删除视频失败:",t),w.error(t.message||"删除失败")}}function G(e){P.push(`/aiedu/ppt-to-video/edit/${e.id}`)}function O(e){return e?new Date(e).toLocaleString():"-"}function q(e){if(!e)return"--:--";let t;if(typeof e=="string"){if(/^\d{2}:\d{2}(:\d{2})?$/.test(e))return e;t=parseFloat(e)}else t=e;if(isNaN(t))return"--:--";const o=Math.floor(t/60),l=Math.floor(t%60);return`${o.toString().padStart(2,"0")}:${l.toString().padStart(2,"0")}`}function H(e){return{completed:"success",pending:"warning",processing:"info",failed:"danger"}[e]||"info"}function X(e){return{completed:"已完成",pending:"待处理",processing:"处理中",failed:"失败"}[e]||e}function J(e){return e?`${e.toFixed(0)}%`:"0%"}function K(e,t){switch(e){case"preview":R(t);break;case"delete":A(t);break}}return(e,t)=>{const o=d("el-icon"),l=d("el-button"),f=d("el-progress"),c=d("el-tag"),p=d("el-dropdown-item"),Q=d("el-dropdown-menu"),W=d("el-dropdown"),Y=d("el-card"),Z=d("el-col"),I=d("el-row"),ee=d("el-dialog"),te=d("el-skeleton"),se=d("el-empty");return m(),v("div",ve,[i("div",ge,[t[2]||(t[2]=i("h2",null,"我的视频",-1)),n(l,{type:"primary",onClick:N},{default:a(()=>[n(o,null,{default:a(()=>[n(k(ue))]),_:1}),t[1]||(t[1]=h(" 创作视频 ",-1))]),_:1})]),!b.value&&r.value.length>0?(m(),v("div",he,[n(I,{gutter:20},{default:a(()=>[(m(!0),v(ce,null,de(r.value,s=>(m(),D(Z,{xs:24,sm:24,md:24,lg:6,xl:6,key:s.id,class:"video-card-col"},{default:a(()=>[n(Y,{class:"video-card",shadow:"hover"},{default:a(()=>[i("div",ye,[i("div",{class:"video-thumbnail",onClick:x=>R(s)},[i("img",{src:s.thumbnailUrl||L,alt:"视频封面"},null,8,$e),i("div",be,$(q(s.duration)),1),s.status!=="completed"?(m(),v("div",ke,[s.status==="processing"?(m(),v("div",Te,[n(f,{percentage:s.progress||0,format:J,status:"primary","stroke-width":6,"show-text":!0},null,8,["percentage"]),t[3]||(t[3]=i("span",null,"处理中...",-1))])):(m(),D(c,{key:1,type:H(s.status)},{default:a(()=>[h($(X(s.status)),1)]),_:2},1032,["type"]))])):g("",!0),s.status==="completed"?(m(),v("div",Ue,[n(o,null,{default:a(()=>[n(k(me))]),_:1})])):g("",!0)],8,we),i("div",xe,[i("h3",{class:"video-title",title:s.filename},$(s.filename),9,Ve),i("div",Se,[i("span",Ce,$(O(s.createTime)),1),i("span",De,$(s.fileSize||"-"),1)]),z.value?(m(),v("div",Ee,[n(c,{size:"small",type:"info"},{default:a(()=>[n(o,null,{default:a(()=>[n(k(pe))]),_:1}),h(" "+$(s.username||"未知用户"),1)]),_:2},1024)])):g("",!0)]),i("div",Pe,[i("div",Le,[n(l,{size:"small",type:"primary",onClick:x=>G(s),disabled:s.status!=="completed"&&s.status!=="pending"},{default:a(()=>[...t[4]||(t[4]=[h(" 编辑 ",-1)])]),_:1},8,["onClick","disabled"]),n(l,{size:"small",type:"success",onClick:x=>F(s),disabled:s.status!=="completed"},{default:a(()=>[...t[5]||(t[5]=[h(" 下载 ",-1)])]),_:1},8,["onClick","disabled"])]),i("div",Be,[n(W,{trigger:"click",onCommand:x=>K(x,s)},{dropdown:a(()=>[n(Q,null,{default:a(()=>[n(p,{command:"preview",disabled:s.status!=="completed"},{default:a(()=>[...t[6]||(t[6]=[h(" 预览 ",-1)])]),_:1},8,["disabled"]),n(p,{command:"delete",divided:"",class:"text-danger"},{default:a(()=>[...t[7]||(t[7]=[h(" 删除 ",-1)])]),_:1})]),_:2},1024)]),default:a(()=>[n(l,{size:"small",type:"text"},{default:a(()=>[n(o,null,{default:a(()=>[n(k(_e))]),_:1})]),_:1})]),_:2},1032,["onCommand"])])])])]),_:2},1024)]),_:2},1024))),128))]),_:1})])):g("",!0),n(ee,{modelValue:S.value,"onUpdate:modelValue":t[0]||(t[0]=s=>S.value=s),title:"视频预览",width:"70%","destroy-on-close":"",onClosed:j},{default:a(()=>[T.value?(m(),v("div",Re,[i("video",{controls:"",src:`${k(u)}${T.value.videoUrl}`,style:{width:"100%"},ref_key:"videoPlayer",ref:U,key:"video-player"},null,8,ze)])):g("",!0)]),_:1},8,["modelValue"]),b.value?(m(),v("div",Me,[n(te,{rows:5,animated:""})])):g("",!0),!b.value&&(!r.value||r.value.length===0)?(m(),D(se,{key:2,description:"暂无视频，点击上方按钮开始制作"})):g("",!0)])}}},Ae=oe(Ne,[["__scopeId","data-v-c2672eb9"]]);export{Ae as default};
//# sourceMappingURL=PPTToVideo-e9503e49.js.map
