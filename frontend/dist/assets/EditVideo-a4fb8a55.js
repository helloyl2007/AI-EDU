import{_ as te,u as le,U as se,r,G as L,o as ne,E as l,k as $,b as u,c as ie,h as re,d as g,e as h,f as n,g as a,w as i,n as N,l as T,m as R,F as ue,j as de,p as ce,t as ve,s as _e,V as pe,C as fe,X as me}from"./index-3f8b9c66.js";import{V as ge}from"./VoiceSelector-1fed147c.js";const he={class:"video-editor","element-loading-text":"正在加载视频数据..."},ye={class:"editor-header"},we={class:"editor-main"},be={class:"editor-sidebar-left"},Ve={key:0,class:"thumbnails-list"},ke=["onClick"],$e=["src","alt"],xe={class:"thumbnail-index"},Ce={class:"editor-content"},Ie={key:0,class:"preview-section"},Ue=["src"],Te={class:"notes-section"},De={class:"editor-sidebar-right"},Be={class:"tools-section"},Ee={key:0,class:"settings-section"},Se={key:0,class:"video-container"},Ne=["src"],Re={key:1,class:"no-video"},ze={__name:"EditVideo",setup(Pe){const M=le(),j=se(),y=parseInt(j.params.id),p="http://edu.xiaojuai.com:8100",I=r(!0),w=r([]),c=r(-1),f=r(""),s=r([]),b=r(""),d=r(!1),v=r(""),x=r(!1),U=r(null),V=r(3),k=r("aixia"),D=L(()=>w.value.map(o=>`${p}${o}`)),B=L(()=>c.value>=0&&D.value.length>0?D.value[c.value]:null);ne(async()=>{try{await A()}catch(o){l.error("加载视频数据失败"),console.error("加载视频数据失败:",o)}finally{I.value=!1}});async function A(){try{const e=(await $.get(`${p}/api/ppt2video/edit/${y}`)).data;console.log("加载到的视频数据:",e),w.value=e.images||[],s.value=e.notes||[],b.value=e.session_id,k.value=e.voice_type||"aixia",V.value=e.duration||3,console.log(`加载了 ${w.value.length} 张幻灯片和 ${s.value.length} 条解说文本`),console.log("解说文本示例:",s.value.slice(0,2)),w.value.length>0&&(c.value=0,f.value=s.value[0]||"",console.log("选择第一张幻灯片，笔记内容:",f.value));try{const t=await $.get(`${p}/api/video/${y}`);t.data&&t.data.videoUrl&&(v.value=t.data.videoUrl)}catch(t){console.warn("获取视频URL失败:",t)}}catch(o){throw console.error("加载视频数据失败:",o),l.error("加载视频数据失败"),o}}function F(){M.push("/aiedu/ppt-to-video")}function G(o){c.value=o,f.value=s.value[o]||""}async function z(){if(!b.value||!s.value.length)return console.log("没有数据可保存"),!1;try{S();const o={sessionId:b.value,notes:s.value,duration:V.value,voiceType:k.value,video_id:y};console.log(`开始保存草稿，videoId=${y}`);const e=await $.post(`${p}/api/ppt2video/save-draft`,o);return console.log("草稿保存结果:",e.data),e.data&&e.data.status==="success"?!0:(console.error("保存失败:",e.data?.message||"未知错误"),!1)}catch(o){return console.error("保存草稿异常:",o),!1}}async function q(){S(),I.value=!0;try{await z()?l.success("草稿保存成功"):l.warning("保存失败，请稍后再试")}catch(o){console.error("保存草稿处理错误:",o),l.error("保存失败: "+(o.message||"未知错误"))}finally{I.value=!1}}async function X(){try{if(await z(),await _e.confirm("确定要重新生成视频吗？这将覆盖原有视频。","重新生成视频",{confirmButtonText:"确认生成",cancelButtonText:"取消",type:"warning"}),d.value=!0,console.log("提交视频生成请求:",{sessionId:b.value,notes:s.value,duration:V.value,voiceType:k.value,video_id:y}),!b.value)throw new Error("会话ID不能为空");(!s.value||s.value.length===0)&&console.warn("警告: 解说文本为空或长度为0");const o=await $.post(`${p}/api/ppt2video/generate-video`,{sessionId:b.value,notes:s.value,duration:V.value,voiceType:k.value,video_id:y});if(console.log("生成视频响应:",o.data),o.data.task_id){const e=o.data.task_id;l.success("视频生成任务已提交，正在后台处理中..."),E(e)}else throw new Error("未获取到任务ID")}catch(o){if(o==="cancel")return;console.error("生成视频失败:",o),l.error(o.response?.data?.detail||"生成视频失败，请重试"),d.value=!1}}function E(o,e=0){setTimeout(async()=>{try{const t=await $.get(`${p}/api/ppt2video/task/${o}`),m=t.data.status;m==="completed"?(d.value=!1,v.value=t.data.result.video_url,l.success("视频重新生成成功!"),x.value=!0):m==="failed"?(d.value=!1,l.error(`视频生成失败: ${t.data.error||"未知错误"}`)):m==="running"||m==="pending"?e<120?(d.value=!0,E(o,e+1)):(d.value=!1,l.info('视频生成仍在进行中，请稍后在"我的视频"列表中查看结果。')):(d.value=!1,l.warning('无法获取视频生成状态，请在"我的视频"列表中查看结果。'))}catch(t){console.error("获取任务状态失败:",t),e<10?E(o,e+1):(d.value=!1,l.error('获取视频生成状态失败，请在"我的视频"列表中查看结果。'))}},1e3)}function H(){v.value?(v.value=`${v.value}?t=${new Date().getTime()}`,x.value=!0):$.get(`${p}/api/video/${y}`).then(o=>{o.data&&o.data.videoUrl?(v.value=o.data.videoUrl,x.value=!0):l.info("无法获取视频URL")}).catch(()=>{l.error("无法获取视频信息")})}function S(){c.value>=0&&f.value!==s.value[c.value]&&(console.log(`更新第 ${c.value+1} 页解说文本:`,f.value),s.value[c.value]=f.value)}function J(){U.value&&(U.value.pause(),U.value.currentTime=0)}return(o,e)=>{const t=u("el-icon"),m=u("el-button"),K=u("el-page-header"),O=u("el-scrollbar"),Q=u("el-input"),W=u("el-button-group"),Y=u("el-input-number"),P=u("el-form-item"),Z=u("el-form"),ee=u("el-empty"),oe=u("el-dialog"),ae=ie("loading");return re((g(),h("div",he,[n("div",ye,[a(K,{onBack:F,title:"返回列表",content:"编辑视频"},{extra:i(()=>[a(m,{type:"primary",disabled:!B.value,onClick:q},{default:i(()=>[a(t,null,{default:i(()=>[a(T(pe))]),_:1}),e[4]||(e[4]=R(" 保存草稿 ",-1))]),_:1},8,["disabled"])]),_:1})]),n("div",we,[n("div",be,[w.value.length>0?(g(),h("div",Ve,[a(O,{height:"calc(100vh - 180px)"},{default:i(()=>[(g(!0),h(ue,null,de(D.value,(_,C)=>(g(),h("div",{key:C,class:ce(["thumbnail-item",{active:c.value===C}]),onClick:Le=>G(C)},[n("img",{src:_,alt:"幻灯片 "+(C+1)},null,8,$e),n("div",xe,"第 "+ve(C+1)+" 页",1)],10,ke))),128))]),_:1})])):N("",!0)]),n("div",Ce,[B.value?(g(),h("div",Ie,[n("img",{src:B.value,alt:"当前幻灯片",class:"preview-image"},null,8,Ue)])):N("",!0),n("div",Te,[a(Q,{modelValue:f.value,"onUpdate:modelValue":e[0]||(e[0]=_=>f.value=_),type:"textarea",rows:3,resize:o.none,placeholder:"在此输入当前页面的解说文字...",onBlur:S},null,8,["modelValue","resize"])])]),n("div",De,[n("div",Be,[a(W,{vertical:""},{default:i(()=>[a(m,{type:"success",onClick:X,loading:d.value,disabled:!w.value.length||d.value},{default:i(()=>[a(t,null,{default:i(()=>[a(T(fe))]),_:1}),e[5]||(e[5]=R(" 重新生成视频 ",-1))]),_:1},8,["loading","disabled"]),a(m,{type:"info",onClick:H,disabled:!v.value},{default:i(()=>[a(t,null,{default:i(()=>[a(T(me))]),_:1}),e[6]||(e[6]=R(" 预览视频 ",-1))]),_:1},8,["disabled"])]),_:1})]),w.value.length>0?(g(),h("div",Ee,[e[8]||(e[8]=n("h4",null,"视频设置",-1)),a(Z,{"label-position":"top",size:"small"},{default:i(()=>[a(P,{label:"每页停留时间"},{default:i(()=>[a(Y,{modelValue:V.value,"onUpdate:modelValue":e[1]||(e[1]=_=>V.value=_),min:1,max:20,step:1,size:"small"},null,8,["modelValue"]),e[7]||(e[7]=n("span",{class:"unit"},"秒",-1))]),_:1}),a(P,{label:"语音类型"},{default:i(()=>[a(ge,{modelValue:k.value,"onUpdate:modelValue":e[2]||(e[2]=_=>k.value=_)},null,8,["modelValue"])]),_:1})]),_:1})])):N("",!0)])]),a(oe,{modelValue:x.value,"onUpdate:modelValue":e[3]||(e[3]=_=>x.value=_),title:"视频预览",width:"70%","custom-class":"video-preview-dialog","destroy-on-close":"",onClosed:J},{default:i(()=>[v.value?(g(),h("div",Se,[n("video",{controls:"",src:`${T(p)}${v.value}`,style:{width:"100%"},ref_key:"videoPlayer",ref:U,key:"video-preview"},null,8,Ne)])):(g(),h("div",Re,[a(ee,{description:"尚未生成视频"})]))]),_:1},8,["modelValue"])])),[[ae,I.value,void 0,{fullscreen:!0,lock:!0}]])}}},Ae=te(ze,[["__scopeId","data-v-b6fccc02"]]);export{Ae as default};
//# sourceMappingURL=EditVideo-a4fb8a55.js.map
