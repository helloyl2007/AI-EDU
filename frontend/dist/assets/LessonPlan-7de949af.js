import{$ as re,a0 as ie,a1 as C,a2 as ce,a3 as ue,a4 as A,a5 as de,a6 as pe,a7 as me,_ as fe,r as m,a8 as ge,G as Y,a9 as ve,b as i,d as p,e as b,g as o,w as l,f as c,l as K,m as w,t as _e,n as Q,i as q,F as X,aa as he,E as u,ab as ye,Y as be,ac as we,M as xe}from"./index-3f8b9c66.js";async function Se(x,f="教案"){const r=document.createElement("div");r.innerHTML=x;const s=new re({styles:{default:{document:{run:{size:24,font:"Microsoft YaHei"},paragraph:{spacing:{line:440,before:120,after:120}}}}},sections:[{properties:{},children:ke(r)}]});return await ie.toBlob(s)}function ke(x){if(!x)return[new C({text:"内容无法解析"})];const f=[];try{const r=x.querySelector("table");if(r){const s=[],n=r.querySelectorAll("tr");for(let g=0;g<n.length;g++){const v=n[g],L=[],P=v.querySelectorAll("th, td");for(let T=0;T<P.length;T++){const E=P[T],D=parseInt(E.getAttribute("rowspan"))||1,V=parseInt(E.getAttribute("colspan"))||1,S=[];E.innerHTML.split(/<br\s*\/?>/i).forEach(R=>{const _=document.createElement("div");_.innerHTML=R;const O=_.textContent;O&&O.split(`
`).forEach((M,k)=>{M.trim()&&S.push(new C({children:[new ce({text:M.trim()})],spacing:{before:0,after:0}}))})}),S.length===0&&S.push(new C({text:""})),L.push(new ue({children:S,rowSpan:D,columnSpan:V,borders:{top:{style:A.SINGLE,size:1},bottom:{style:A.SINGLE,size:1},left:{style:A.SINGLE,size:1},right:{style:A.SINGLE,size:1}}}))}L.length>0&&s.push(new de({children:L}))}s.length>0&&f.push(new pe({rows:s,width:{size:100,type:me.PERCENTAGE}}))}else x.textContent.trim().split(`
`).forEach(n=>{n.trim()&&f.push(new C({text:n.trim()}))})}catch(r){return console.error("处理HTML内容出错:",r),[new C({text:`处理错误: ${r.message}`})]}return f.length===0&&f.push(new C({text:"无内容"})),f}const Ce={class:"lesson-plan-container"},Le={class:"form-container scrollable-area"},Te={key:0,class:"uploaded-file"},Ee={class:"file-name"},Ie={class:"card-header"},ze={key:0,class:"header-actions"},Fe={class:"result-container scrollable-area"},Ne={key:1,class:"empty-result"},Pe=["innerHTML"],Ve={__name:"LessonPlan",setup(x){const f=m(he),r=m(!1),s=m(""),n=ge({scopeSelection:[],topic:"",planDetails:"",lessonCount:1}),g=m([]),v=m(null),L=Y(()=>{const t=localStorage.getItem("token");return{Authorization:t?`Bearer ${t}`:""}}),P=Y(()=>"http://edu.xiaojuai.com:8100/api/lesson-plan/upload-plan"),T=t=>{v.value={...t,uniqueFilename:"",uploaded:!1},g.value=[t],localStorage.removeItem("lessonPlanFile")},E=t=>{const e=[".txt",".docx",".doc",".pdf"],a=t.name.substring(t.name.lastIndexOf(".")).toLowerCase();return e.includes(a)?t.size/1024/1024<10?!0:(u.error("文件大小不能超过10MB"),!1):(u.error("只能上传txt、docx、doc或pdf格式的文件"),!1)},D=(t,e)=>{if(t.success){const a={uniqueFilename:t.filename,name:e.name};localStorage.setItem("lessonPlanFile",JSON.stringify(a)),v.value={...e,uploaded:!0,uniqueFilename:t.filename},n.planDetails=t.content,u.success("参考资料上传成功")}else V(t.message||"上传失败")},V=t=>{u.error(typeof t=="string"?t:"上传失败，请重试"),v.value=null,g.value=[]},S=async()=>{await H(),v.value=null,n.planDetails="",g.value=[]};ve(()=>{H()});const H=async()=>{const t=localStorage.getItem("lessonPlanFile");if(t)try{const e=JSON.parse(t);if(e?.uniqueFilename){console.log("开始清理文件",e.uniqueFilename);const a=localStorage.getItem("token");await fetch("http://edu.xiaojuai.com:8100/api/lesson-plan/remove-file",{method:"POST",headers:{Authorization:a?`Bearer ${a}`:"","Content-Type":"application/json"},body:JSON.stringify({filename:e.uniqueFilename})}),localStorage.removeItem("lessonPlanFile"),console.log("文件清理完成")}}catch(e){console.error("清理文件失败:",e)}},R=t=>{const e=t.replace(/<(?![\/]?(tr|td|table|strong|pre|br)[>\ ])([^>])*>/g,""),a=(e.match(/<tr|<td|<table|<strong|<pre/g)||[]).length,d=(e.match(/<\/tr|<\/td|<\/table|<\/strong|<\/pre/g)||[]).length;return a===d?e:t.substring(0,t.lastIndexOf("<"))},_=m(!1),O=async()=>{if(!n.scopeSelection||n.scopeSelection.length<3){u.warning("请选择年级和科目");return}if(!n.topic.trim()){u.warning("请输入课题");return}r.value=!0,_.value=!0;let t="";try{const a=(await fetch("http://edu.xiaojuai.com:8100/api/lesson-plan/generate",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify(n)})).body.getReader(),d=new TextDecoder;let I=!1;for(;;){const{done:j,value:B}=await a.read();if(j)break;const $=d.decode(B,{stream:!0}).split(`
`);for(const h of $)if(h.startsWith("data: ")){const z=h.slice(5).trim();if(z==="[DONE]")continue;try{const N=JSON.parse(z).choices[0].delta.content||"";!I&&N&&(r.value=!1,I=!0),t+=N,s.value=R(t)}catch(F){z!=="[DONE]"&&console.error("解析数据失败:",F)}}}s.value=t,u.success("教案生成成功")}catch(e){console.error("生成教案失败:",e),u.error("生成教案失败，请重试")}finally{r.value=!1,_.value=!1}},G=t=>t?ye.sanitize(t):"",M=async()=>{try{if(console.log("开始导出Word..."),!s.value||s.value.trim()===""){u.warning("没有可导出的内容");return}console.log("准备导出内容长度:",s.value.length);const t=await Se(s.value,n.topic||"教案"),e=window.URL.createObjectURL(t),a=document.createElement("a");a.href=e,a.download=`${n.topic||"教案"}.docx`,document.body.appendChild(a),a.click(),setTimeout(()=>{window.URL.revokeObjectURL(e),document.body.removeChild(a)},100),u.success("导出成功")}catch(t){console.error("导出失败详细信息:",t),u.error(`导出失败: ${t.message||"未知错误"}`)}},k=m(!1),U=m(""),J=m(""),Z=()=>{J.value=s.value,U.value=s.value,k.value=!0},ee=()=>{s.value=U.value,k.value=!1,u.success("保存成功")},te=()=>{s.value=J.value,k.value=!1},oe=["正在分析教学目标...","正在设计教学环节...","正在优化教学方案...","正在完善教学设计..."],le=["教学目标","重难点","教学方法","课程结构","教学活动","板书设计"];return(t,e)=>{const a=i("el-cascader"),d=i("el-form-item"),I=i("el-input"),j=i("el-input-number"),B=i("el-icon"),W=i("el-upload"),$=i("el-tag"),h=i("el-button"),z=i("el-form"),F=i("el-card"),N=i("el-col"),ne=i("el-empty"),se=i("el-row");return p(),b("div",Ce,[o(se,{gutter:20,class:"full-height-row"},{default:l(()=>[o(N,{span:10,class:"full-height-col"},{default:l(()=>[o(F,{class:"settings-card"},{header:l(()=>[...e[4]||(e[4]=[c("div",{class:"card-header"},[c("h3",null,"备课助手")],-1)])]),default:l(()=>[c("div",Le,[o(z,{model:n,"label-position":"top"},{default:l(()=>[o(d,{label:"年级和科目"},{default:l(()=>[o(a,{modelValue:n.scopeSelection,"onUpdate:modelValue":e[0]||(e[0]=y=>n.scopeSelection=y),options:f.value.options,props:{checkStrictly:!1,leaf:(y,ae)=>ae.level===3},placeholder:"请选择年级和科目",style:{width:"100%"}},null,8,["modelValue","options","props"])]),_:1}),o(d,{label:"课题"},{default:l(()=>[o(I,{modelValue:n.topic,"onUpdate:modelValue":e[1]||(e[1]=y=>n.topic=y),placeholder:"请输入本节课的课题"},null,8,["modelValue"])]),_:1}),o(d,{label:"课时数"},{default:l(()=>[o(j,{modelValue:n.lessonCount,"onUpdate:modelValue":e[2]||(e[2]=y=>n.lessonCount=y),min:1,max:10,"controls-position":"right",style:{width:"180px"}},null,8,["modelValue"])]),_:1}),o(d,null,{label:l(()=>[...e[5]||(e[5]=[c("span",null,"参考资料",-1),c("span",{class:"optional-note"},"*上传本节课的教材内容会更准确，如没有可不传",-1)])]),default:l(()=>[o(W,{class:"plan-upload-container","auto-upload":!0,"on-change":T,"on-remove":S,"before-upload":E,"on-success":D,"on-error":V,"file-list":g.value,action:P.value,headers:L.value,accept:".txt,.docx,.doc,.pdf",drag:""},{tip:l(()=>[...e[6]||(e[6]=[c("div",{class:"upload-tip"}," 支持 txt、docx、doc、pdf 格式，文件大小不超过10MB ",-1)])]),default:l(()=>[o(B,{class:"el-icon--upload"},{default:l(()=>[o(K(be))]),_:1}),e[7]||(e[7]=c("div",{class:"el-upload__text"},[w(" 将文件拖到此处或 "),c("em",null,"点击选择文件")],-1))]),_:1},8,["file-list","action","headers"]),v.value?.uploaded?(p(),b("div",Te,[o(B,{color:"#67C23A"},{default:l(()=>[o(K(we))]),_:1}),c("span",Ee,_e(v.value.name),1),o($,{type:"success",size:"small"},{default:l(()=>[...e[8]||(e[8]=[w("已上传",-1)])]),_:1})])):Q("",!0)]),_:1}),o(d,null,{default:l(()=>[o(h,{type:"primary",loading:r.value,onClick:O,size:"large",disabled:_.value},{default:l(()=>[...e[9]||(e[9]=[w(" 生成教案 ",-1)])]),_:1},8,["loading","disabled"])]),_:1})]),_:1},8,["model"])])]),_:1})]),_:1}),o(N,{span:14,class:"full-height-col"},{default:l(()=>[o(F,{class:"result-card"},{header:l(()=>[c("div",Ie,[e[14]||(e[14]=c("h3",null,"教案内容",-1)),s.value?(p(),b("div",ze,[k.value?(p(),b(X,{key:1},[o(h,{type:"success",size:"small",onClick:ee},{default:l(()=>[...e[11]||(e[11]=[w("保存",-1)])]),_:1}),o(h,{size:"small",onClick:te},{default:l(()=>[...e[12]||(e[12]=[w("取消",-1)])]),_:1})],64)):(p(),q(h,{key:0,type:"primary",size:"small",onClick:Z,disabled:_.value},{default:l(()=>[...e[10]||(e[10]=[w(" 编辑 ",-1)])]),_:1},8,["disabled"])),o(h,{type:"primary",size:"small",onClick:M,disabled:_.value},{default:l(()=>[...e[13]||(e[13]=[w(" 导出文档 ",-1)])]),_:1},8,["disabled"])])):Q("",!0)])]),default:l(()=>[c("div",Fe,[r.value&&!t.streamContent?(p(),q(xe,{key:0,stages:oe,keywords:le,"position-class":"position-right",show:!0})):s.value?(p(),b(X,{key:2},[k.value?(p(),q(I,{key:1,modelValue:U.value,"onUpdate:modelValue":e[3]||(e[3]=y=>U.value=y),type:"textarea",rows:20,resize:"none",class:"edit-textarea"},null,8,["modelValue"])):(p(),b("div",{key:0,class:"lesson-content",innerHTML:G(s.value)},null,8,Pe))],64)):(p(),b("div",Ne,[o(ne,{description:"暂无教案，请设置条件并点击生成"})]))])]),_:1})]),_:1})]),_:1})])}}},Me=fe(Ve,[["__scopeId","data-v-93ca1572"]]);export{Me as default};
//# sourceMappingURL=LessonPlan-7de949af.js.map
