import{_ as he,u as ye,U as we,r as n,H as be,o as Pe,a as ke,G as H,k as P,E as s,b as r,c as Ve,h as Y,d as p,e as m,f as o,g as a,w as l,n as R,l as k,m as V,F as Te,j as Ce,p as xe,t as Ie,i as $e,s as Ue,V as Se,W as Be,C as De,X as ze,Y as Ee}from"./index-3f8b9c66.js";import{V as Ne}from"./VoiceSelector-1fed147c.js";const Le={class:"video-editor","element-loading-text":"PPT正在解析中..."},Me={class:"editor-header"},Ae={class:"editor-main"},Fe={class:"editor-sidebar-left"},Re={class:"upload-section"},We={key:0,class:"thumbnails-list"},je=["onClick"],qe=["src","alt"],Ge={class:"thumbnail-index"},Xe={class:"editor-content"},He={key:0,class:"preview-section"},Ye=["src"],Je={class:"notes-section"},Ke={class:"editor-sidebar-right"},Oe={class:"tools-section"},Qe={key:0,class:"settings-section"},Ze={key:0,class:"video-container"},et=["src"],tt={key:1,class:"no-video"},at={__name:"CreateVideo",setup(lt){const J=ye(),K=we(),v="http://edu.xiaojuai.com:8100",O=`${v}/api/ppt2video/upload`,Q={Authorization:`Bearer ${localStorage.getItem("token")}`},y=n([]),g=n(-1),T=n(""),f=n([]),h=n(""),C=n(!1),W=n([]),D=n(!1),c=n(!1),x=n(""),I=n(!1),_=n(!1),$=n(3),U=n("aixia"),w=n(null);be([h,f],()=>{},{deep:!0}),Pe(()=>{const t=K.query.pptId;t&&(console.log("检测到PPT ID参数:",t),de(t))}),ke(()=>{});async function z(){if(!h.value||!f.value.length)return!1;try{B();const t={sessionId:h.value,notes:f.value,duration:$.value,voiceType:U.value,video_id:w.value};console.log(`保存草稿，videoId=${w.value||"新建"}`);const e=await P.post(`${v}/api/ppt2video/save-draft`,t);return e.data&&e.data.status==="success"?(!w.value&&e.data.video_id&&(w.value=e.data.video_id,console.log(`获取到新视频ID: ${w.value}`)),!0):(console.warn("保存草稿失败:",e.data?.message),!1)}catch(t){return console.error("保存草稿出错:",t),!1}}const E=H(()=>y.value.map(t=>`${v}${t}`)),N=H(()=>g.value>=0&&E.value.length>0?E.value[g.value]:null),S=n(null);function Z(){J.push("/aiedu/ppt-to-video")}function ee(t){const e=t.name.toLowerCase().endsWith(".ppt"),i=t.name.toLowerCase().endsWith(".pptx"),u=e||i,A=t.size/1024/1024<50;return u?A?(_.value=!0,console.log("File type check:",{name:t.name,type:t.type,size:t.size,isValidType:u,isPPT:e,isPPTX:i}),!0):(s.error("文件大小不能超过 50MB!"),!1):(s.error("只支持 .ppt 和 .pptx 格式的文件!"),!1)}function L(t){C.value=!1,y.value=t.images,f.value=t.notes||new Array(t.images.length).fill(""),h.value=t.id,t.images&&t.images.length>0&&(g.value=0,T.value=f.value[0]||""),_.value=!1,z()}function te(t){s.error("上传失败，请重试"),console.error("Upload error:",t),_.value=!1}function ae(t){g.value=t,T.value=f.value[t]||""}function le(){B(),z().then(t=>{t?s.success("草稿已保存"):s.warning("保存失败，请稍后再试")})}async function oe(){try{if(y.value.length===0){s.warning("请先上传或选择一个PPT文件");return}B(),await z(),await Ue.confirm("确定开始生成视频吗？根据幻灯片数量和备注长度，这可能需要几分钟时间。","生成视频",{confirmButtonText:"确认生成",cancelButtonText:"取消",type:"info"}),c.value=!0;const t=await P.post(`${v}/api/ppt2video/generate-video`,{sessionId:h.value,notes:f.value,duration:$.value,voiceType:U.value,video_id:w.value});if(console.log("生成视频响应:",t.data),t.data.task_id){const e=t.data.task_id;s.success("视频生成任务已提交，正在后台处理中..."),M(e)}else throw new Error("未获取到任务ID")}catch(t){if(t==="cancel")return;console.error("生成视频失败:",t),s.error(t.response?.data?.detail||"生成视频失败，请重试"),c.value=!1}}function M(t,e=0){setTimeout(async()=>{try{const i=await P.get(`${v}/api/ppt2video/task/${t}`),u=i.data.status;u==="completed"?(c.value=!1,x.value=i.data.result.video_url,s.success("视频生成成功!"),I.value=!0):u==="failed"?(c.value=!1,s.error(`视频生成失败: ${i.data.error||"未知错误"}`)):u==="running"||u==="pending"?e<120?(c.value=!0,M(t,e+1)):(c.value=!1,s.info('视频生成仍在进行中，请稍后在"我的视频"列表中查看结果。')):(c.value=!1,s.warning('无法获取视频生成状态，请在"我的视频"列表中查看结果。'))}catch(i){console.error("获取任务状态失败:",i),e<10?M(t,e+1):(c.value=!1,s.error('获取视频生成状态失败，请在"我的视频"列表中查看结果。'))}},1e3)}function se(){x.value?I.value=!0:s.info("请先生成视频")}function ne(){C.value=!0,ie()}async function ie(){D.value=!0;try{const t=await P.get(`${v}/api/ppt/list`);W.value=t.data.items.filter(e=>e.status==="completed").map(e=>({...e,id:e.id?String(e.id):void 0}))}catch(t){console.error("获取课件列表失败:",t),s.error("获取课件列表失败")}finally{D.value=!1}}async function re(t){try{C.value=!1,_.value=!0;const e=await P.post(`${v}/api/ppt2video/convert-system-ppt`,{pptId:t.id});if(e.data.status==="success")h.value=e.data.id,L(e.data);else throw new Error(e.data.detail||"转换失败")}catch(e){console.error("选择课件失败:",e),s.error(e.response?.data?.detail||"选择课件失败"),_.value=!1}}function B(){g.value>=0&&(f.value[g.value]=T.value)}function ue(){S.value&&(S.value.pause(),S.value.currentTime=0)}async function de(t){try{_.value=!0;const e=await P.post(`${v}/api/ppt2video/convert-system-ppt`,{pptId:t});if(e.data.status==="success")h.value=e.data.id,L(e.data),s.success("PPT已成功加载");else throw new Error(e.data.detail||"转换失败")}catch(e){console.error("自动加载PPT失败:",e),s.error(e.response?.data?.detail||"加载PPT失败"),_.value=!1}}return(t,e)=>{const i=r("el-icon"),u=r("el-button"),A=r("el-page-header"),j=r("el-scrollbar"),ce=r("el-input"),ve=r("el-button-group"),pe=r("el-input-number"),q=r("el-form-item"),fe=r("el-form"),_e=r("el-empty"),G=r("el-dialog"),F=r("el-table-column"),me=r("el-table"),ge=r("el-upload"),X=Ve("loading");return Y((p(),m("div",Le,[o("div",Me,[a(A,{onBack:Z,title:"返回列表",content:"视频制作"},{extra:l(()=>[a(u,{type:"primary",disabled:!N.value,onClick:le},{default:l(()=>[a(i,null,{default:l(()=>[a(k(Se))]),_:1}),e[5]||(e[5]=V(" 保存草稿 ",-1))]),_:1},8,["disabled"])]),_:1})]),o("div",Ae,[o("div",Fe,[o("div",Re,[a(u,{type:"primary",onClick:ne},{default:l(()=>[a(i,null,{default:l(()=>[a(k(Be))]),_:1}),e[6]||(e[6]=V(" 选择课件 ",-1))]),_:1})]),y.value.length>0?(p(),m("div",We,[a(j,{height:"calc(100vh - 222px)"},{default:l(()=>[(p(!0),m(Te,null,Ce(E.value,(d,b)=>(p(),m("div",{key:b,class:xe(["thumbnail-item",{active:g.value===b}]),onClick:ot=>ae(b)},[o("img",{src:d,alt:"幻灯片 "+(b+1)},null,8,qe),o("div",Ge,"第 "+Ie(b+1)+" 页",1)],10,je))),128))]),_:1})])):R("",!0)]),o("div",Xe,[N.value?(p(),m("div",He,[o("img",{src:N.value,alt:"当前幻灯片",class:"preview-image"},null,8,Ye)])):R("",!0),e[7]||(e[7]=o("div",{class:"setting-tip"},"解说内容：",-1)),o("div",Je,[a(ce,{modelValue:T.value,"onUpdate:modelValue":e[0]||(e[0]=d=>T.value=d),type:"textarea",rows:3,resize:t.none,placeholder:"在此输入当前页面的解说文字...",onBlur:B},null,8,["modelValue","resize"])])]),o("div",Ke,[o("div",Oe,[a(ve,{vertical:""},{default:l(()=>[a(u,{type:"success",onClick:oe,loading:c.value,disabled:!y.value.length||c.value},{default:l(()=>[a(i,null,{default:l(()=>[a(k(De))]),_:1}),e[8]||(e[8]=V(" 生成视频 ",-1))]),_:1},8,["loading","disabled"]),a(u,{type:"info",onClick:se,disabled:!x.value},{default:l(()=>[a(i,null,{default:l(()=>[a(k(ze))]),_:1}),e[9]||(e[9]=V(" 预览视频 ",-1))]),_:1},8,["disabled"])]),_:1})]),y.value.length>0?(p(),m("div",Qe,[e[12]||(e[12]=o("h4",null,"视频设置",-1)),a(fe,{"label-position":"top",size:"small"},{default:l(()=>[a(q,{label:"每页停留时间"},{default:l(()=>[a(pe,{modelValue:$.value,"onUpdate:modelValue":e[1]||(e[1]=d=>$.value=d),min:1,max:20,step:1,size:"small"},null,8,["modelValue"]),e[10]||(e[10]=o("span",{class:"unit"},"秒",-1)),e[11]||(e[11]=o("div",{class:"setting-tip"},"默认3秒，一般不用修改",-1))]),_:1}),a(q,{label:"语音类型"},{default:l(()=>[a(Ne,{modelValue:U.value,"onUpdate:modelValue":e[2]||(e[2]=d=>U.value=d)},null,8,["modelValue"])]),_:1})]),_:1})])):R("",!0)])]),a(G,{modelValue:I.value,"onUpdate:modelValue":e[3]||(e[3]=d=>I.value=d),title:"视频预览",width:"70%","custom-class":"video-preview-dialog",onClosed:ue},{default:l(()=>[x.value?(p(),m("div",Ze,[o("video",{controls:"",src:`${k(v)}${x.value}`,style:{width:"100%"},ref_key:"videoPlayer",ref:S},null,8,et)])):(p(),m("div",tt,[a(_e,{description:"尚未生成视频"})]))]),_:1},8,["modelValue"]),a(G,{modelValue:C.value,"onUpdate:modelValue":e[4]||(e[4]=d=>C.value=d),title:"选择课件",width:"60%",class:"file-select-dialog"},{default:l(()=>[a(j,{height:"250px"},{default:l(()=>[Y((p(),$e(me,{data:W.value,style:{width:"100%"},"max-height":250},{default:l(()=>[a(F,{prop:"title",label:"课件标题"}),a(F,{prop:"createTime",label:"创建时间",width:"180"}),a(F,{label:"操作",width:"120",fixed:"right"},{default:l(d=>[a(u,{link:"",type:"info",onClick:b=>re(d.row)},{default:l(()=>[...e[13]||(e[13]=[V(" 选择 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[X,D.value]])]),_:1}),e[15]||(e[15]=o("div",{class:"divider"},[o("span",null,"或者上传新文件")],-1)),a(ge,{class:"upload-new",drag:"",action:O,accept:".ppt,.pptx","on-success":L,"on-error":te,"before-upload":ee,headers:Q},{default:l(()=>[a(i,{class:"el-icon--upload"},{default:l(()=>[a(k(Ee))]),_:1}),e[14]||(e[14]=o("div",{class:"el-upload__text"},[V(" 拖拽文件到此处或 "),o("em",null,"点击上传")],-1))]),_:1})]),_:1},8,["modelValue"])])),[[X,_.value,void 0,{fullscreen:!0,lock:!0}]])}}},it=he(at,[["__scopeId","data-v-4e742c49"]]);export{it as default};
//# sourceMappingURL=CreateVideo-8c529adb.js.map
